---
import { getCollection } from 'astro:content';
import SidebarLayout from '@layouts/SidebarLayout.astro';
import ResearchCard from '@components/ResearchCard.astro';
import SearchFilter from '@components/SearchFilter';
import { filterDrafts, sortByDate, getAllTags } from '@utils/index';

const allResearch = await getCollection('research');
const publishedResearch = sortByDate(filterDrafts(allResearch));

// Get all tags from research
const allTags = getAllTags(publishedResearch);

// Format posts for SearchFilter component (including raw content)
const formattedPosts = await Promise.all(
  publishedResearch.map(async (research) => {
    const { Content } = await research.render();
    return {
      slug: research.slug,
      title: research.data.title,
      description: research.data.description,
      date: research.data.date.toISOString(),
      tags: research.data.tags,
      image: research.data.image,
      imageAlt: research.data.imageAlt,
      content: research.body, // Raw markdown content for searching
    };
  })
);
---

<SidebarLayout title="All Research" description="Browse all my research" maxWidth="wide">
  <div class="mb-10">
    <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-3 tracking-tight">Research</h1>
    <p class="text-gray-600 text-base">
      Browse and search through all my research publications
    </p>
  </div>

  <SearchFilter
    client:load
    posts={formattedPosts}
    allTags={allTags}
    collection="research"
  />
</SidebarLayout>
