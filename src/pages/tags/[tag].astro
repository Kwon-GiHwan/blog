---
import { getCollection } from 'astro:content';
import SidebarLayout from '@layouts/SidebarLayout.astro';
import ProjectCard from '@components/ProjectCard.astro';
import ResearchCard from '@components/ResearchCard.astro';
import { filterDrafts, sortByDate, getAllTags } from '@utils/index';

export async function getStaticPaths() {
  const allProjects = await getCollection('projects');
  const publishedProjects = filterDrafts(allProjects);

  const allResearch = await getCollection('research');
  const publishedResearch = filterDrafts(allResearch);

  const combinedContent = [...publishedProjects, ...publishedResearch];
  const allTags = getAllTags(combinedContent);

  return allTags.map(tag => {
    const filteredProjects = publishedProjects.filter(project =>
      project.data.tags.includes(tag)
    );
    const filteredResearch = publishedResearch.filter(research =>
      research.data.tags.includes(tag)
    );

    return {
      params: { tag },
      props: {
        projects: sortByDate(filteredProjects),
        research: sortByDate(filteredResearch),
        tag,
      },
    };
  });
}

const { projects, research, tag } = Astro.props;
const totalCount = projects.length + research.length;
---

<SidebarLayout title={`Tag: ${tag}`} description={`All content tagged with ${tag}`}>
  <div class="mb-12">
    <h1 class="text-4xl font-bold text-gray-900 mb-4">
      <span class="text-blue-600">#</span>{tag}
    </h1>
    <p class="text-gray-600">
      {totalCount} {totalCount === 1 ? 'item' : 'items'} with this tag
    </p>
  </div>

  <!-- Projects Section -->
  {projects.length > 0 && (
    <section class="mb-12">
      <h2 class="text-2xl font-semibold text-gray-900 mb-6">
        Projects ({projects.length})
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {projects.map(project => (
          <ProjectCard project={project} />
        ))}
      </div>
    </section>
  )}

  <!-- Research Section -->
  {research.length > 0 && (
    <section>
      <h2 class="text-2xl font-semibold text-gray-900 mb-6">
        Research ({research.length})
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {research.map(item => (
          <ResearchCard research={item} />
        ))}
      </div>
    </section>
  )}

  <!-- Back Link -->
  <div class="mt-12 pt-8 border-t border-gray-200">
    <a
      href="/tags"
      class="inline-flex items-center text-blue-600 hover:text-blue-700 font-medium transition-colors"
    >
      ‚Üê View all tags
    </a>
  </div>
</SidebarLayout>
