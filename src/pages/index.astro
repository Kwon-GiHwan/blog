---
import { getCollection } from 'astro:content';
import SidebarLayout from '@layouts/SidebarLayout.astro';
import FeaturedSplitView from '@components/FeaturedSplitView';
import ExperienceTimeline from '@components/ExperienceTimeline.astro';
import SkillsFilter from '@components/SkillsFilter';
import { filterDrafts, sortByDate } from '@utils/index';

// Get all content (projects + research)
const allProjects = await getCollection('projects');
const allResearch = await getCollection('research');
const allContent = [...filterDrafts(allProjects), ...filterDrafts(allResearch)];

// Format for Split View (top 8 posts)
const splitViewPosts = sortByDate(allContent)
  .slice(0, 8)
  .map(post => ({
    slug: post.slug,
    title: post.data.title,
    description: post.data.description,
    abstract: post.data.abstract || post.data.description,
    date: post.data.date.toISOString(),
    image: post.data.image,
    imageAlt: post.data.imageAlt,
    tags: post.data.tags,
    collection: post.collection as 'projects' | 'research',
  }));

// Get experiences
const experiences = await getCollection('experiences');
const publishedExperiences = experiences.filter(exp =>
  import.meta.env.DEV || !exp.data.draft
);

// Extract all unique skills from experiences
const allSkillsFromExperiences = [
  ...new Set(
    publishedExperiences.flatMap(exp => exp.data.skills)
  )
].sort();

// Format posts for the filter component
const formattedPosts = allContent.map(item => ({
  slug: item.slug,
  title: item.data.title,
  description: item.data.description,
  tags: item.data.tags,
  date: item.data.date.toISOString(),
  collection: item.collection as 'projects' | 'research',
}));
---

<SidebarLayout
  title="Home - Your Name"
  description="Portfolio showcasing projects and research in software development"
  maxWidth="wide"
>
  <!-- Hero Section with optimal reading width -->
  <section class="mb-20">
    <h1 class="text-5xl md:text-6xl font-bold text-gray-900 mb-6 leading-tight tracking-tight">
      Hi, I'm <span class="text-blue-600">Your Name</span>
    </h1>
    <p class="text-xl text-gray-600 max-w-2xl leading-relaxed">
      Software developer passionate about building elegant solutions to complex problems.
      I work at the intersection of design and engineering, creating experiences that matter.
    </p>
  </section>

  <!-- Featured Split View Section -->
  {splitViewPosts.length > 0 ? (
    <section class="mb-20">
      <h2 class="text-3xl font-bold text-gray-900 mb-8 tracking-tight">
        Featured Projects & Research
      </h2>
      <FeaturedSplitView client:load posts={splitViewPosts} />
    </section>
  ) : (
    <div class="text-center py-20 border border-dashed border-gray-300 rounded-lg bg-gray-50">
      <p class="text-gray-600 text-lg mb-3 font-medium">
        No content yet
      </p>
      <p class="text-gray-500 text-sm max-w-md mx-auto leading-relaxed">
        Start by creating markdown files in <code class="text-pink-600 bg-white px-2 py-1 rounded font-mono text-xs">src/content/projects/</code> or <code class="text-pink-600 bg-white px-2 py-1 rounded font-mono text-xs">src/content/research/</code>
      </p>
    </div>
  )}

  <!-- Experience Timeline Section -->
  {publishedExperiences.length > 0 && (
    <section class="mb-20">
      <h2 class="text-3xl font-bold text-gray-900 mb-8 tracking-tight">
        Work Experience
      </h2>
      <ExperienceTimeline />
    </section>
  )}

  <!-- Skills & Evidence Section -->
  {allSkillsFromExperiences.length > 0 && (
    <section class="mb-20">
      <h2 class="text-3xl font-bold text-gray-900 mb-8 tracking-tight">
        Skills & Evidence
      </h2>
      <SkillsFilter
        client:load
        allPosts={formattedPosts}
        allSkills={allSkillsFromExperiences}
      />
    </section>
  )}
</SidebarLayout>
